---
title: "Math 23C Term Project"
author: "Robi Rahman and Sharon Tai"
date: "24 March - 14 May 2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(eeptools) # to import the decomma() function
library(boot)
library(caret)
library(psych)
library(ggplot2)
```

## Question

Can the price changes in certain commodities reveal the kind of recession the U.S. is in? How do
qualitatively different recessions affect commodities’ prices? We are specifically interested in the
dotcom crash of the early 2000s, the Great Recession, and the COVID-19 pandemic. 


## Motivation

“The stock market is not the economy.” This refrain frequently sounds. We have decided to assess
whether commodity prices that could signal the health of the general public correlated with
unemployment rates across two decades. The three significant recessions in this time period affected
different populations differently. Could the differences in commodity prices signal which populations
were significantly affected, and how affected they were? Are there differences in how each type of
recession affects them?

In general, the risk-adjusted long-run expected returns to all publicly traded assets are the same
throughout the economy. If one commodity had a higher expected return than another, traders would
sell the less profitable asset and buy the more profitable one, until the costs of each are proportionate
to their future returns. The best null hypothesis for changes in asset prices is that all of them
(specifically all the ones that are equally risky) will rise or fall by the same amount, all other factors
equal.

However, different goods change in value differently in relation to different world events, and some
commodities are correlated with other ones. We have selected a list of commodities that we 
hypothesize will behave differently during qualitatively different recessions. Did some of the selected
commodities respond differently to these qualitatively different recessions?

Auxiliary questions we’ll be considering are
1. What the price signals about the good and its consumers
2. Whether there were supply and demand shocks that affected the prices


## Hypothesis

Robi:

Commodities tend to increase in price when the economy is growing. Recessions
are periods with negative GDP growth, so commodity prices will decrease, or at
least increase by a lesser amount on average than during growth periods.

Unemployment generally rises during recessions and is low when the economy is
strong. Therefore, we will find that unemployment rates are higher during recessions
than during non-recession periods.

The 2020-21 coronavirus pandemic is an exception to these, with high unemployment
but a prosperous stock market. It will appear different than the other two recessions,
such that you can distinguish it from the rest of the data set based on its upward
trend in commodity prices.

## Analysis - Robi

We obtained monthly time series data for nine commodities (crude oil, sugar,
soybeans, wheat, beef, rubber, cocoa beans, gold, ice cream)^[https://www.indexmundi.com/commodities/], the US unemployment
rate^[https://beta.bls.gov/dataViewer/view/timeseries/LNS14000000], the US dollar to Euro exchange rate^[https://fred.stlouisfed.org/series/DEXUSEU],
and an indicator of past US economic recession dates^[https://fred.stlouisfed.org/series/JHDUSRGDPBR].
The data were cleaned, then merged into a dataframe with one observation of each
piece of information for every month from February 2001 to February 2021, giving
twenty years of historical data going back from this course's spring semester. This
interval includes the 2020-21 coronavirus pandemic, the 2007-2009 financial crisis,
and the early-2000s dotcom stock crash. The three recessions were assigned a
categorical/factor variable in a new column of the dataframe.

To test the hypothesis that commodities had better performance (in the sense
of prices increasing over time) during during non-recession periods than during
recessions, a new dataframe was created by dividing each commodity's price in
each month by its price in the previous month to obtain a table of percentage
changes. Histograms were created for each good individually and for all goods
together, showing the distribution of changes in price for the whole period,
recessions only, and growth periods only. The histograms were extremely similar
across these different categories, somewhat contravening the hypothesis that
prices would go up during non-recession periods and down during recessions.

Next, logistic regression was used in an attempt to differentiate between
recession and non-recession periods. If price changes in goods are distributed
differently between these two types of periods, it should be possible to construct
a logistic function of a month's price changes whose output is the probability
that a month was during a recession, and which is highly correlated with the
historical recession indicator. This turned out not to be the case. Logistic models
of some of the variables individually, all of the variables together, and some
combinations of variables were all completely ineffective at predicting past
recessions. Not only did the models exhibit almost no change in their values
of recession probability over the range of observed price increases, the predictions
created by deploying these models on the training dataset performed far worse
(around 55%) than the no-information accuracy rate, a strategy of simply guessing
that every month is not a recession (which is true around 85% of the time).

```{r}
# Loading the cleaned data
price_changes <- read.csv("price changes.csv")[,2:15]

# Let's use ice cream for this example, since all the goods fare so poorly.
icecream_regression <- glm(recession_bool ~ Ice_cream, data = price_changes, family = 'binomial')
# Logistic model of recession probability based on price change of ice cream:
summary(icecream_regression)

plot(price_changes$Ice_cream, price_changes$recession_bool, col=c("blue"),
     xlab="Monthly price change of ice cream", ylab="Recession indicator",
     main="Ice cream price changes in non-recession and recession periods")
curve(inv.logit(-1.5900*x-1.6687), add=TRUE)
# You can see that the prediction only ranges from 20% probability that a recession
# is happening in a month when the price of ice cream crashes by 15%, compared to
# a 15% chance that there is currently a recession while the price of ice cream
# is soaring by 15%.


icecream_predictions <- as.factor(predict(icecream_regression, newdata=price_changes, type='response') > inv.logit(-1.6687))
confusionMatrix(icecream_predictions, reference = as.factor(price_changes$recession_bool==1))
```
As you can see from the confusion matrix, the model makes 20 correct positive
predictions, 109 correct negative predictions, 13 false negative predictions,
and 93 false positive predictions, for an accutacy of 54%. In contrast, simply
claiming that all months are *not* recessions would produce 0 correct positive
predictions, 202 correct negative predictions, 0 false positive predictions,
and 38 false negative predictions, for an accuracy of 84%!

Therefore, contingency tables were used as another method to either show that
price changes in recession and non-recession months could be distinguished, or
confirm the model's findings that they cannot be.

```{r}
change_vs_recession <- read.csv("cvr1.csv")
hist(change_vs_recession$change, col="lightblue", main="Frequency of price changes (all goods, 2001-21)")
table(change_vs_recession$change >= 0, change_vs_recession$recession_bool)

# During recessions: price diff >= 0 212 times; price diff < 0 168 times
# During other times: price diff >= 0 1130 times; price diff < 0 890 times

212/(212+168) # Price goes up 55.8% of the time during recessions
1130/(1130+890) # Price goes up 55.9% of the time without recession

# Repeat the above analysis, but break up the recession category into three.
change_vs_recession <- read.csv("cvr2.csv")
table(change_vs_recession$change >= 0, change_vs_recession$which_recession)

1130/(890+1130) # Prices increased 55.9% of the time outside of recessions
38/(38+42) # # Prices increased 47.5% of the time during the dotcom recession
101/(101+79) # Prices increased 56.1% of the time during the housing crisis
73/(73+47) # Prices increased 60.8% of the time during the COVID pandemic

df <- tibble::tribble(
  ~x, ~y, ~price,
  "non-recession", 1130,  "same/increased",
  "non-recession", -890,  "decreased",
  
  "recession", 212,  "same/increased",
  "recession", -168,  "decreased",
  
)
ggplot(data = df, aes(x, y, group = price)) +
  geom_col(aes(fill = price), position = position_stack(reverse = TRUE)) +
  geom_hline(yintercept = 0) +
  xlab("") + ylab("") + ggtitle("Likelihood of price increases vs recession")

df <- tibble::tribble(
  ~x, ~y, ~price,
  
  "dotcom crash", 38,"same/increased",
  "dotcom crash", -42,  "decreased",
  
  "financial crisis", 101,"same/increased",
  "financial crisis", -79,  "decreased",
  
  
  "COVID pandemic", 73,"same/increased",
  "COVID pandemic", -47,  "decreased",
)
ggplot(data = df, aes(x, y, group = price)) +
  geom_col(aes(fill = price), position = position_stack(reverse = TRUE)) +
  geom_hline(yintercept = 0) +
  xlab("") + ylab("") + ggtitle("Likelihood of price increases vs recession")
```

As seen by the contingency tables, there is no difference in probability that
commodity prices were flat/increasing rather than decreasing in the overall
categories of recessions vs non-recession periods, though within the recession
category, commodities performed worse during the dotcom crash than during the
financial crisis or the coronavirus pandemic. These results all contradict the
hypotheses that commodities perform better outside of recessions, and that
they performed better during the coronavirus pandemic than during the other two
recessions.



For a comparison of classical and simulation methods of statistical inference,
a bootstrap test and a two-sample t test were conducted to compare the mean
unemployment rate during recession and non-recession periods.

```{r echo=FALSE}
set.seed(2021)

unemployment_vs_recession <- price_changes[,12:13]

total_recession <- sum(unemployment_vs_recession[,2]) # 38
total_nonrecession <- 240-total_recession # 202

indicator <- function(x) x == 1
not_indicator <- function(x) x == 0

avg_unemp_in_recession <- sum(unemployment_vs_recession[,1]*indicator(unemployment_vs_recession[,2]))/38
avg_unemp_not_recession <- sum(unemployment_vs_recession[,1]*not_indicator(unemployment_vs_recession[,2]))/202

observed_difference <- avg_unemp_in_recession - avg_unemp_not_recession


diffs <- numeric(1000)
for (i in 1:1000) {
  unemps <- sample(unemployment_vs_recession[,1])
  recession_avg <- sum(unemps*indicator(unemployment_vs_recession[,2]))/38
  nonrecession_avg <- sum(unemps*not_indicator(unemployment_vs_recession[,2]))/202
  diffs[i] <- recession_avg - nonrecession_avg
}
pvalue <- sum(diffs > observed_difference)/1000
```
```{r}
hist(diffs, col="lightblue", main="Shuffled differences in unemployment")
abline(v=observed_difference, col="red")

pvalue
# p-value = 0.004, so there is a significant difference in unemployment during
#                  recessions and non-recession periods!
```
As shown by the observed difference overlaid on a histogram of simulated differences,
and the the p-value of 0.004 for the null hypothesis that the two categories
have the same mean unemployment rate, the bootstrap test suggests that unemployment
is significantly higher during recessions.

```{r echo=FALSE}
set.seed(2022)

recession_unemployment_rates <- unemployment_vs_recession$Unemployment[unemployment_vs_recession$recession_bool==1]
nonrecession_unemployment_rates <- unemployment_vs_recession$Unemployment[unemployment_vs_recession$recession_bool==0]

rur <- mean(recession_unemployment_rates)
nur <- mean(nonrecession_unemployment_rates)
rsd <- sd(recession_unemployment_rates)
nsd <- sd(nonrecession_unemployment_rates)

recession_samples <- sample(recession_unemployment_rates,size=16,replace=TRUE)
nonrecession_samples <- sample(nonrecession_unemployment_rates,size=16,replace=TRUE)

hist(recession_unemployment_rates, probability = TRUE, col="lightblue", main="Histogram of monthly unemployment rates during recessions")
curve(dnorm(x,mean=rur,sd=rsd),add=TRUE, col="red")
abline(v=rur, col="red")
abline(v=rur-1.96*rsd/sqrt(16), col="red")
abline(v=rur+1.96*rsd/sqrt(16), col="red")

hist(nonrecession_unemployment_rates, probability = TRUE, col="lightblue", main="Histogram of monthly unemployment rates outside of recessions")
curve(dnorm(x,mean=nur,sd=nsd),add=TRUE, col="red")
abline(v=nur, col="red")
abline(v=nur-1.96*nsd/sqrt(16), col="red")
abline(v=nur+1.96*nsd/sqrt(16), col="red")
```
```{r}
t.test(recession_samples,nonrecession_samples,alternative="two.sided")
```

For comparison, a two-sample t test does not find that there is a significant
difference in the mean unemployment rate for recession and non-recession months.
In this case, the bootstrap test is likely to be a more reliable method because
several prerequisite assumptions for the statistical validity of the t test are
not met, such as normality of the distribution of unemployment rates, or equal
variance in unemployment within the recession vs non-recession periods.



Finally, some advanced regression techniques can be used for modeling applications
based on this dataset. Stepwise regression is a technique wherein a model of many
variables is evaluated, then based on adjusted $R^2$ or other criteria, variables
are added or removed and the model is re-evaluated, until it has reached some
optimal condition. Using the MASS and car libraries, unemployment was modeled
as a linear function of all the other variables, which were then pruned if they
did not contribute to the predictive capability of the model.

```{r echo=FALSE, results='hide'}
library(MASS)
library(car)
```

```{r}
unemployment_reg <- lm(Unemployment ~ ., data=price_changes[,2:13])
vif(unemployment_reg)
summary(unemployment_reg)
```
```{r echo=TRUE, results='hide'}
stepAIC(unemployment_reg)
# Output too long for PDF - view results in R script.
```


First, a model was created using all of the variables. Then, the variables were
cross-examined to find their variance inflation factors. All of the values are
less than 2, indicating that the predictors are not related to each other, and
this regression model does not suffer from multicollinearity. Therefore, all of
these variables may be used in a multiple linear regression model of recessions.

Based on the model summary, none of the variables are significant predictors of
unemployment except for the recession indicator. (If there is multicollinearity,
it is possible to erroneously find that all of the independent variables are not
significantly related to the dependent variable even though they may be strongly
correlated to it as a whole. However, based on the VIFs, that is not occurring here.)

A stepwise regression improves this model by optimizing the Akaike information
criterion to remove unnecessary variables. The stepwise regression shows that
the model is optimized when all variables are eliminated except for the
recession indicator and the price change of crude oil. It is impractical to predict
unemployment using current commodity price fluctuations!

However, this may be more achievable using not only data from the current month,
but several months of data history. Vector autoregression is a technique that allows
a model to take into account a vector of lagged values of the independent variables.

```{r echo=FALSE, results='hide'}
library(vars)
```
```{r}
var_aic <- VAR(price_changes[,2:13], type = "none", lag.max = 5, ic = "AIC")
```
```{r echo=TRUE, results='hide'}
summary(var_aic)
# Output too long for PDF - view results in R script.
```

It turns out that trying to predict recessions from price history of these goods
is futile. None of the variables, nor their histories, are significant contributors
to the likelihood of recession in the next month, except for whether there was a
recession during the previous month. Of note, however, recessions and crude oil
prices are significantly predictive of unemployment, and so could be used to
forecast upcoming job market trends.




---------------



## Distribution Analysis - Sharon

```{r}

```
## Comparison Across Goods

# Prices
During the two decades...the first half and second half...
The effects during a recession...achieved more granularity by using daily data.

# Price Changes
Using daily data

# Difference in Price Changes
Using daily data









